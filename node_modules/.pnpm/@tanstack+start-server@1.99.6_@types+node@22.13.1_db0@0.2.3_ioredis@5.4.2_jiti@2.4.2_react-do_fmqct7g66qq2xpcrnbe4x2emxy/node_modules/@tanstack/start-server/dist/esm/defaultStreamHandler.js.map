{"version":3,"file":"defaultStreamHandler.js","sources":["../../src/defaultStreamHandler.tsx"],"sourcesContent":["import { PassThrough } from 'node:stream'\nimport { isbot } from 'isbot'\nimport ReactDOMServer from 'react-dom/server'\nimport { StartServer } from './StartServer'\n\nimport {\n  transformPipeableStreamWithRouter,\n  transformReadableStreamWithRouter,\n} from './transformStreamWithRouter'\nimport type { ReadableStream } from 'node:stream/web'\nimport type { AnyRouter } from '@tanstack/react-router'\n\nexport type HandlerCallback<TRouter extends AnyRouter> = (ctx: {\n  request: Request\n  router: TRouter\n  responseHeaders: Headers\n}) => Response | Promise<Response>\n\nexport const defaultStreamHandler: HandlerCallback<AnyRouter> = async ({\n  request,\n  router,\n  responseHeaders,\n}) => {\n  if (typeof ReactDOMServer.renderToReadableStream === 'function') {\n    const stream = await ReactDOMServer.renderToReadableStream(\n      <StartServer router={router} />,\n      {\n        signal: request.signal,\n      },\n    )\n\n    if (isbot(request.headers.get('User-Agent'))) {\n      await stream.allReady\n    }\n\n    const responseStream = transformReadableStreamWithRouter(\n      router,\n      stream as unknown as ReadableStream,\n    )\n\n    return new Response(responseStream as any, {\n      status: router.state.statusCode,\n      headers: responseHeaders,\n    })\n  }\n\n  if (typeof ReactDOMServer.renderToPipeableStream === 'function') {\n    const reactAppPassthrough = new PassThrough()\n\n    try {\n      const pipeable = ReactDOMServer.renderToPipeableStream(\n        <StartServer router={router} />,\n        {\n          ...(isbot(request.headers.get('User-Agent'))\n            ? {\n                onAllReady() {\n                  pipeable.pipe(reactAppPassthrough)\n                },\n              }\n            : {\n                onShellReady() {\n                  pipeable.pipe(reactAppPassthrough)\n                },\n              }),\n          onError: (error, info) => {\n            console.error('Error in renderToPipeableStream:', error, info)\n          },\n        },\n      )\n    } catch (e) {\n      console.error('Error in renderToPipeableStream:', e)\n    }\n\n    const responseStream = transformPipeableStreamWithRouter(\n      router,\n      reactAppPassthrough,\n    )\n\n    return new Response(responseStream as any, {\n      status: router.state.statusCode,\n      headers: responseHeaders,\n    })\n  }\n\n  throw new Error(\n    'No renderToReadableStream or renderToPipeableStream found in react-dom/server. Ensure you are using a version of react-dom that supports streaming.',\n  )\n}\n"],"names":[],"mappings":";;;;;;AAkBO,MAAM,uBAAmD,OAAO;AAAA,EACrE;AAAA,EACA;AAAA,EACA;AACF,MAAM;AACA,MAAA,OAAO,eAAe,2BAA2B,YAAY;AACzD,UAAA,SAAS,MAAM,eAAe;AAAA,MAClC,oBAAC,eAAY,QAAgB;AAAA,MAC7B;AAAA,QACE,QAAQ,QAAQ;AAAA,MAAA;AAAA,IAEpB;AAEA,QAAI,MAAM,QAAQ,QAAQ,IAAI,YAAY,CAAC,GAAG;AAC5C,YAAM,OAAO;AAAA,IAAA;AAGf,UAAM,iBAAiB;AAAA,MACrB;AAAA,MACA;AAAA,IACF;AAEO,WAAA,IAAI,SAAS,gBAAuB;AAAA,MACzC,QAAQ,OAAO,MAAM;AAAA,MACrB,SAAS;AAAA,IAAA,CACV;AAAA,EAAA;AAGC,MAAA,OAAO,eAAe,2BAA2B,YAAY;AACzD,UAAA,sBAAsB,IAAI,YAAY;AAExC,QAAA;AACF,YAAM,WAAW,eAAe;AAAA,QAC9B,oBAAC,eAAY,QAAgB;AAAA,QAC7B;AAAA,UACE,GAAI,MAAM,QAAQ,QAAQ,IAAI,YAAY,CAAC,IACvC;AAAA,YACE,aAAa;AACX,uBAAS,KAAK,mBAAmB;AAAA,YAAA;AAAA,UACnC,IAEF;AAAA,YACE,eAAe;AACb,uBAAS,KAAK,mBAAmB;AAAA,YAAA;AAAA,UAErC;AAAA,UACJ,SAAS,CAAC,OAAO,SAAS;AAChB,oBAAA,MAAM,oCAAoC,OAAO,IAAI;AAAA,UAAA;AAAA,QAC/D;AAAA,MAEJ;AAAA,aACO,GAAG;AACF,cAAA,MAAM,oCAAoC,CAAC;AAAA,IAAA;AAGrD,UAAM,iBAAiB;AAAA,MACrB;AAAA,MACA;AAAA,IACF;AAEO,WAAA,IAAI,SAAS,gBAAuB;AAAA,MACzC,QAAQ,OAAO,MAAM;AAAA,MACrB,SAAS;AAAA,IAAA,CACV;AAAA,EAAA;AAGH,QAAM,IAAI;AAAA,IACR;AAAA,EACF;AACF;"}